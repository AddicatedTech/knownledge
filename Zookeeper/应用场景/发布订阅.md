# 发布订阅



## 原理

客户端向服务端注册自己需要关注的节点，一旦该节点的数据发生变更，那么服务端就会向订阅的客户端发送watcher事件通知。客户端接收到消息通知后，需要主动到服务端获取最新的数据。



根据此特性，可以实现配置中心。



##实现配置中心

目前很多公司开发或者使用的程序都是分布式的，而程序总会或多或少的存在一些额外配置，且分散部署在多台机器上。某一条要修改配置，要逐个去修改配置就变得有些困难，特别是应用部署的点数特别大的时候，就成了不可能完成的事情了。一种方式就是把相关配置写到数据库中，每个应用去读取数据库的配置，这种方式优点就是把配置集中管理，缺点也很明显，就是不能及时获得配置的变革，要及时获得变更后的配置，就要不停的去扫描数据库，而这又会造成数据库的压力巨大。

我要说的这种方式就是利用zookeeper的这种发布订阅、watch来实现。即，把相关的配置数据写到zookeeper的某个指定的节点下。应用服务监听这个节点的数据变化，一旦节点数据（配置信息）发生了变化，应用服务就会收到zookeeper的通知，然后应用服务就可以从zookeeper获得新的配置信息。

![image-20191019170141180](https://tva1.sinaimg.cn/large/006y8mN6gy1g83m8wkajwj30te0hkgq7.jpg)







我们平时使用的配置中心，就可以利用ZK来实现。步骤如下：



### 配置存储

把初始化配置存储到ZK的某个节点上

![image-20191019163337317](https://tva1.sinaimg.cn/large/006y8mN6gy1g83lfq83j4j31bg0es0zl.jpg)

写入的配置如：

![image-20191019163406691](https://tva1.sinaimg.cn/large/006y8mN6gy1g83lg7icq3j30zi0ak41m.jpg)





### 配置获取

集群中每台机器在启动初始化阶段，首先会从上面提到的ZK节点上读取数据库信息。同时，客户端还在该节点上注册一个watcher监听，一旦节点数据变更，所有订阅的客户端都能收到通知。





### 配置变更

当ZK节点中数据内容更新了，ZK就把数据变更的通知发送到订阅的客户端。每个客户端接收到通知后，就可以进行最新数据的获取。