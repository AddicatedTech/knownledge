# 原子操作



## 处理器实现原子操作

![image-20191110163905447](https://tva1.sinaimg.cn/large/006y8mN6gy1g8t187dgmij31jw0pwnhh.jpg)

处理器使用缓存加锁或者总线加锁的方式来实现多处理器之间的原子操作。

首先处理器会自动保证基本的内存操作的原子性。处理器保证从内存中读取或者写入一个字节是原子的。当一个处理器读取一个字节的时候，其他处理器不能访问这个字节的地址。

但是复杂的内存操作，处理器提供总线锁定、缓存锁定两个机制来保证原子性。



### 总线锁定

使用总线锁定保证原子性。所谓的总线锁，就是使用处理器提供的一个Lock#信号，当一个处理器在总线上输出此信号时，其他处理器的请求将被阻塞住，那么该处理器就可以独占共享内存。



### 缓存锁定

在同一时刻，我们只需要保证某个地址的操作是原子性即可，但是总线锁定期间，其他处理器不能操作其他地址的数据，极大地影响了性能。因此在某些场合下，可以通过缓存锁定来保证原子性，以优化性能。

**有两种情况不会使用缓存锁定**

- 当操作的数据不能被缓存在处理器内部，或者操作的数据涉及多个缓存行。这时处理器会使用总线锁定。
- 有些处理器不支持缓存锁定





## Java实现原子操作

java可以通过锁和cas实现原子操作。



### CAS

CAS通过处理器提供的指令实现的。自旋CAS实现的思路就是循环进行CAS操作，直到成功为止。

从Java ·1.5，并发包中提供了AtomicInteger这些原子操作类。

CAS能够解决原子更新问题，也能够实现乐观锁。

但是CAS也存在问题：

- ABA问题
- 如果重试次数过多，那么循环时间长，开销大
- 只能确保一个变量的更新保持原子性



### 锁机制

锁机制保证只有获取锁的线程才能操作被锁定的区域，从而保证原子性。

JVM内部实现了很多锁的机制，如偏向锁、轻量级锁、重量级锁。除了偏向锁，JVM实现锁的方式都用了CAS。当一个线程想进入同步块时，通过循环CAS获取锁，当它退出同步块时，使用循环CAS释放锁。

