# HashMap

我们在一般情况下，都会使用无参构造方法创建 HashMap。但当我们对时间和空间复杂度有要求的时候，使用默认值有时可能达不到我们的要求，这个时候我们就需要手动调参。在 HashMap 构造方法中，可供我们调整的参数有两个，一个是初始容量 initialCapacity，另一个负载因子 loadFactor。通过设定这两个参数，可以进一步影响阈值大小。但初始阈值 threshold 仅由 initialCapacity 经过移位操作计算得出。他们的作用分别如下：

| initialCapacity | HashMap 初始容量                                             |
| --------------- | ------------------------------------------------------------ |
| loadFactor      | 负载因子                                                     |
| threshold       | 当前 HashMap 所能容纳键值对数量的最大值，超过这个值，则需扩容 |

负载因子（loadFactor）。对于 HashMap 来说，负载因子是一个很重要的参数，该参数反应了 HashMap 桶数组的使用情况（假设键值对节点均匀分布在桶数组中）。通过调节负载因子，可使 HashMap 时间和空间复杂度上有不同的表现。

- 当我们调低负载因子时，HashMap 所能容纳的键值对数量变少。扩容时，重新将键值对存储新的桶数组里，键的键之间产生的碰撞会下降，链表长度变短。此时，HashMap 的增删改查等操作的效率将会变高，这里是典型的拿空间换时间。
- 相反，如果增加负载因子（负载因子可以大于1），HashMap 所能容纳的键值对数量变多，空间利用率高，但碰撞率也高。这意味着链表长度变长，效率也随之降低，这种情况是拿时间换空间。至于负载因子怎么调节，这个看使用场景了。一般情况下，我们用默认值就可以了。





## put插入元素

- 找到桶的位置  
  - 使用(n - 1) & hash，这也说明了为什么数组长度是2的整数次幂
- 插入到链表尾部
- 如果是红黑树，则插入到红黑树中
- 插入完毕后，判断需不需要进行扩容



## 扩容

在 HashMap 中，桶数组的长度均是2的次幂，阈值大小为桶数组长度与负载因子的乘积。当 HashMap 中的键值对数量超过阈值时，进行扩容。

若size大于threshold的时候，就会进行扩容。HashMap 按当前桶数组长度的2倍进行扩容，阈值也变为原来的2倍（如果计算过程中，阈值溢出归零，则按阈值公式重新计算）。扩容之后，要重新计算键值对的位置，并把它们移动到合适的位置上去。

![image-20191015102021139](https://tva1.sinaimg.cn/large/006y8mN6gy1g7yo64l5n5j30kj0ce439.jpg)

rehash是非常耗时的。在编写程序中，尽量确定HashMap的初始容量大小，从而避免rehash。



**hashmap扩容时每个entry需要再计算一次hash吗？**

首先明确1.7和1.8都是扩容2倍。

1.8之前（如1.7）会将每个entry进行rehash。（算法设计如此）

1.8之后不用，将算法进行了优化，**因为元素的位置要么是在原位置，要么是在原位置+旧数组容量的位置**，

所以只要把原来桶中的链表分为新旧两个表就好了，不用重新计算hash值。





**jdk1.8之前并发操作hashmap时为什么会有死循环的问题？**

jdk1.7中，链表插入新节点**采用的是头插法**，这样在多线程扩容迁移元素时，会将元素顺序改变，导致两个线程中出现元素的相互指向而形成环型的链表，然后调用get()方法的时候，就可能会产生死循环。

**jdk1.8 采用了尾插法**，从根源上杜绝了这种情况的发生





## 参考

https://www.cnblogs.com/zhangyinhua/p/7698642.html#_label1

https://cloud.tencent.com/developer/article/1338265

https://juejin.im/post/5d412a5be51d45620e0b99af

[HashMap源码分析]([http://www.tianxiaobo.com/2018/01/18/HashMap-%E6%BA%90%E7%A0%81%E8%AF%A6%E7%BB%86%E5%88%86%E6%9E%90-JDK1-8/](http://www.tianxiaobo.com/2018/01/18/HashMap-源码详细分析-JDK1-8/))

[扩容](https://www.jianshu.com/p/1ff9f3dee207)

[HashMap死循环](https://www.jianshu.com/p/1e9cf0ac07f4)

