# 灰度系统



## 概要

主要功能是 灰度后台代码，区分正式/灰度环境，减少上线风险。提高用户体验。



## 原理



### 划分灰度环境

在服务启动时，根据该服务的灰度机器列表，判断该服务下这个台机器是否需要灰度，如果是，则设置为灰度环境配置。具体配置如下：设置生产者的group属性值为灰度分组（标明该provider是灰度服务），设置消费者的默认filter为”grayFilter“（一般情况下，使用该grayFilter预防调用正常服务但是没有设置group的情况）、默认loadBalance为“grayLoadBalance“（一般情况下，使用grayLoadBalance进行消费调用）、group为“*”（为了消费端能获取到所有服务）。



###动态路由

利用dubbo的loadBalance、Filter扩展，达到动态调用灰度/正式服务的效果。在动态调用时需要动态设置group，因为dubbo默认会把ConsumerConfig的group属性值当做参数传递给provider方。
 在provider侧，会从一个Map获取接口的exporter，key类似于 */com.xxxx.xxService.queryMethod这种格式，这样子是拿不到服务的。



## 扩展

com.alibaba.dubbo.common.utils.UrlUtils#isMatch 解释了*为何会匹配到所有invoker