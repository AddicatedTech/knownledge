# 事务

目的：事务会把数据库从一种一致性状态转换为另外一种一致性状态。在数据库提交工作时，可以确保要么所有修改都已经保存好了，要么所有修改都不保存。InnoDB的默认隔离界别是**可重复读**，采用临键锁，避免了不可重复读的问题。



##事务4个特性



###原子性(Atomicity)

事务必须是一个原子的操作序列单元，所有操作要不全部执行成功，要不要全部不执行。



###一致性(Consistency)

指事务的执行不能破坏数据库数据的完整性和一致性。事务的执行结果必须使数据库从一个一致性状态转换到另外一个一致性状态。



###隔离性(Isolation)

在并发环境中，并发的事务是相互隔离的。不同的事务并发操作相同数据时，各个事务都有各自完整的数据空间，即一个事务内部的操作及数据对其他事务是隔离的，并发执行的各个事务之间不能互相干扰。

**4个隔离级别**

####读未提交

一个事务正在处理数据，并且没有提交，另外一个事务可以读取到这个数据。隔离级别最低

读未提交时，读事务直接读取主记录，无论更新事务是否完成



#### 读已提交

只允许读取另外一个事务已提交的数据

读提交时，读事务每次都读取undo log中最近的版本，因此两次对同一字段的读可能读到不同的数据（幻读），但能保证每次都读到最新的数据。



####可重复读

事务执行过程中，重复读取一个数据时，其值都和事务开始的时候是一样的。可能导致幻影数据。

每次都读取事务开始前的版本，这样保证不会产生幻读，但可能读不到最新的数据（这样子只是保证值是一样的，如果需要避免记录数量的幻读，还需要间隙锁）



####串行化

事务串行执行。锁表，读写相互阻塞，使用较少



![image-20190211215124599](https://ws3.sinaimg.cn/large/006tNc79gy1g02tpcdwamj30lu09otal.jpg)



![image-20190211215145808](https://ws3.sinaimg.cn/large/006tNc79gy1g02tpo4k6ej30ly06k0v0.jpg)

事务的隔离界别越高，就越能保证数据的完整性和一致性，但同时对并发的影响也就越大。



###持久性(Durability)

事务完成后所做的改动都会被持久化，即使发生灾难性的失败。通过日志和同步备份可以在故障发生后重建数据。





















#分布式事务

分布式事务是指 事务的参与者、支持事务的服务器、资源服务器以及事务管理器 分别位于分布式系统的不同节点。通常一个分布式事务中会涉及对多个数据源或者业务系统的操作。



一个分布式事务可以看做由多个分布式的操作序列组成的，通常可以把这一系列分布式的操作序列看成子事务。因此，分布式事务也可以定义为一种嵌套型的事务。



### CAP理论

概念：一个分布式系统不可能同时满足 一致性、可用性、分区容错性 这三个基本需求，最多只能同时满足其中两项。

#### 一致性

在分布式环境中，一致性是指**数据在多个副本之间能否保持一致的特性**。在一致性的需求下，当一个系统在数据一致性的状态下执行更新操作后，应该保证系统仍然处于一致的状态。

对于一个将数据副本分布在不同分布式节点上的操作系统来说，如果对第一个节点的数据更新操作并且更新成功后，却没有使得第二个节点上的数据得到相应的更新，于是对第二个节点的数据进行读取操作时，获取的依然是老数据（或者称为“脏数据”），这就是典型的分布式数据不一致情况。在分布式系统中，如果能够做到针对一个数据项的更新操作执行成功后，所有的用户都可以读取到其最新值，那么这样的系统就被认为具有强一致性（或者严格的一致性）。



#### 可用性

可用性指 **系统提供的服务必须一直处于可用的状态，对于用户的每一个操作请求总是能够在有限的时间内返回结果。**



#### 分区容错性

分区容错性指 **分布式系统在遭遇任何网络分区故障的时候，仍然需要能够保证对外提供满足一致性和可用性的服务，除非是整个网络环境发生了故障。**

**网络分区**指分布式系统中，不同的节点分布在不同的子网络（机房或者异地网络等）中，由于一些特殊的原因导致这些子网络之间出现网络不连通的情况，但各个子网络的内部网络是正常的，从而导致整个系统的网络环境被切分成若干个孤立的区域。需要注意的是，组成一个分布式系统的每个节点的加入与退出，都可以看做是一个特殊的网络分区。



![image-20190211230706364](https://ws3.sinaimg.cn/large/006tNc79gy1g02vw2ae6kj30le07imym.jpg)



![image-20190211230723546](https://ws4.sinaimg.cn/large/006tNc79gy1g02vwd29ipj30li0a879g.jpg)

对于一个分布式系统而言，分区容错性是最基本的需求。为什么这样说，原因很简单，因为既然是分布式系统，那么分布式系统中的组件必然会部署到不同节点上，因此必然出现子网络。既然出现子网络，网络问题就是一个必然会 出现的异常情况，因此必须有对应的应对策略。因此分区容错性成为了分布式系统必然面对和解决的问题。因此系统架构师往往把精力花在如何根据业务特点在C（一致性）和A（可用性）之间寻找平衡。



### BASE理论

