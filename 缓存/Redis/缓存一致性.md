可以根据不同的业务使用不同方式，维护一张表，表里面记录哪些数据一致性要求高，并且缓存设置过期时间。



- 对于一致要求高的数据

使用分布式锁（锁住要使用的key就好），先淘汰缓存，然后操作数据库，操作完释放锁。当前线程正在操作数据库的时候该数据时，如果别的线程想查询db中这部分数据，并且加载数据到缓存。先看能否获取到锁，只有获取到锁，才能继续操作。

![Snip20181122_7](https://ws4.sinaimg.cn/large/006tNbRwgy1fxh28bncmtj30k505bdg8.jpg)

这种情况下，如果先操作数据库，再操作缓存。其实有问题：

（1）存在原子性问题：先操作数据库成功，操作缓存失败，造成不一致。

（2）先操作数据库，在操作数据库期间，其他线程还在读取缓存，读取脏数据。



- 对于一致要求低的数据

同样是先淘汰缓存，然后操作数据库。由于缓存有过期时间，会达到最终一致性。