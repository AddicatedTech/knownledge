# 缓存穿透和缓存雪崩



## 缓存穿透



### 概念

缓存穿透指查询一个一定不存在的数据，首先会缓存未命中，然后直接查询数据库，数据库中也没有这个数据，因此也不会写入缓存中。这将导致每次查询该数据都直接请求到数据库，从而造成缓存穿透。

![image-20191109110015926](https://tva1.sinaimg.cn/large/006y8mN6gy1g8rltbf2zkj30g00im0w3.jpg)



### 解决方案

- 先把数据库所有的主键放入到布隆过滤器中。

- 当发生请求的时候，先去redis缓存中查询该数据
- 如果缓存中没有，利用布隆过滤器判断该主键是否存在(bd.exists指令)
- 如果不存在，则说明数据库没有对应的数据，直接返回。这样子就避免去数据库查询没有的数据。

![image-20191109115222630](https://tva1.sinaimg.cn/large/006y8mN6gy1g8rnbj6pppj30k40majxa.jpg)



这样子肯定也有缺点：

- 使用了布隆过滤器，肯定就要去维护它。
  - 比如说数据库新增了主键key，就要到布隆过滤器中新增该key
  - 如果数据库删除了某些数据，就要到布隆过滤器中删除该key。通过expire key 0设置过期时间为0就可以实现删除





## 缓存雪崩

### 概念

如果缓存集中在一段时间内失效，所有的查询都落在数据库上，数据库调用了暴增，造成数据库挂掉的情况，这就是缓存雪崩。

![image-20191109120302486](https://tva1.sinaimg.cn/large/006y8mN6gy1g8rnmml3eij310m0lcwnm.jpg)





### 解决方案

- 应用层限流，避免同一时间大量请求导致数据库压力暴增，服务不可用。
- 使用redis集群保证缓存层高可用
- 给缓存设置不同的过期时间，避免同一时间点大量缓存过期失效
- 数据预热，预先把热点数据存入缓存中
- 一致性hash（减少雪崩造成的影响）







## 参考

[缓存穿透和缓存雪崩](https://www.cnblogs.com/George1994/p/10668889.html)

[布隆过滤器解决缓存穿透](https://q.cnblogs.com/q/117521/)